#!/usr/sh
#
# makefile for fitpot
#

PMDDIR=../pmd
#-----------------------------------------------------------------------
# to be generated by configure script
#-----------------------------------------------------------------------
CPP= @CPP@
CPPFLAGS= @CPPFLAGS@
MPIFC= @FC@
MPIFLAGS= @FCFLAGS@ -I${PMDDIR}
#-----------------------------------------------------------------------
# suffixes
.SUFFIXES: .o .f .F .f90 .F90
.f.o: 
	${MPIFC} -c ${MPIFLAGS} $<
.F.o: 
	${MPIFC} -c ${MPIFLAGS} ${CPPFLAGS} $<
.f90.o: 
	${MPIFC} -c ${MPIFLAGS} $<
.F90.o: 
	${MPIFC} -c ${MPIFLAGS} ${CPPFLAGS} $<

ifndef VERBOSE
MAKEFLAGS += --no-print-directory
endif

# fitpotobj= NN.o read_input.o fitpot.o read_params.o
fitpotobj= read_input.o fitpot.o read_params.o
mods= mod_variables.o mod_parallel.o mod_minimize.o mod_random.o fp_common.o mod_composition.o
args= iargc.o getarg.o

${PMDDIR}/%.o: ${PMDDIR}/%.F90
	@[ -d ${PMDDIR} ]
	cd ${PMDDIR} && ${MPIFC} -c ${MPIFLAGS} ${CPPFLAGS} -o $@ -c $<

${PMDDIR}/%.o: ${PMDDIR}/%.F
	@[ -d ${PMDDIR} ]
	cd ${PMDDIR} && ${MPIFC} -c ${MPIFLAGS} ${CPPFLAGS} -o $@ -c $<

.PHONY: all clean
all: fitpot

clean:
	rm -f *.o *.mod *~ fitpot

fitpot: ${mods} ${fitpotobj}
	${MPIFC} ${MPIFLAGS} -o $@ $^ -L${PMDDIR} -lpmd

fitpot_examples := ../examples/fitpot_*/
define cd_test
	(cd $(dir ${1}) && make test)

endef

test:
	@$(foreach x,$(wildcard $(fitpot_examples)),$(call cd_test, ${x}))


#.....Dependencies
read_input.o: ${mods}
# fitpot.o: ${mods} NN.o
fitpot.o: ${mods}
# NN.o: ${mods}
mod_minimize.o: mod_random.o

fp_common.o fp_common.mod: fp_common.F90 mod_parallel.o mod_minimize.o
	${MPIFC} -c ${MPIFLAGS} ${CPPFLAGS} $<
